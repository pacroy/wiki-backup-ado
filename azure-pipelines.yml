variables:
- name: kubeContext
  value: ''
- name: kubeNamespace
  value: ''
- name: mysqlAppLabel
  value: ''
- name: bookstackAppLabel
  value: ''

jobs:
- job: 'backup'
  displayName: 'Backup Wiki'
  pool:
    vmImage: 'ubuntu-18.04'
  steps:
  - checkout: none
  - task: Bash@3
    displayName: 'Check Parameters'
    inputs:
      failOnStderr: true
      noProfile: true
      noRc: true
      targetType: 'inline'
      script: |
        [ -z "$(variables.kubeContext)" ] && echo 'Variable "kubeContext" is not set' && exit 1
        [ -z "$(variables.kubeNamespace)" ] && echo 'Variable "kubeNamespace" is not set' && exit 1
        [ -z "$(variables.mysqlAppLabel)" ] && echo 'Variable "mysqlAppLabel" is not set' && exit 1
        [ -z "$(variables.bookstackAppLabel)" ] && echo 'Variable "bookstackAppLabel" is not set' && exit 1
  - task: Bash@3
    displayName: 'Tool Information'
    inputs:
      failOnStderr: false
      noProfile: true
      noRc: true
      targetType: 'inline'
      script: |
        command -v az
        az version
        command -v kubectl
        kubectl version --client=true
  - task: Bash@3
    displayName: 'Backup'
    inputs:
      failOnStderr: true
      noProfile: true
      noRc: true
      targetType: 'inline'
      script: |
        export KUBE_CONTEXT=$(variables.kubeContext)
        export WIKI_NAMSPACE=$(variables.kubeNamespace)
        export MYSQL_APP_LABEL=$(variables.mysqlAppLabel)
        export BOOKSTACK_APP_LABEL=$(variables.bookstackAppLabel)

        # Execute
        bash -e <(curl -s https://raw.githubusercontent.com/pacroy/bookstack-backup/master/backup.sh)